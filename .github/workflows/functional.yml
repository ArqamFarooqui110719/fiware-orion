name: Functional Tests

on:
  push:
  pull_request:
    branches:
      - master

env:
   TEST_IMAGE_NAME: fiware/orion-ci:rpm8

jobs:
  functional:
    runs-on: ubuntu-18.04
    continue-on-error: true

    services:
      mongodb:
        image: mongo:4.4
        ports:
          - 27017:27017

      mosquitto:
        # Needed by MQTT notification tests
        image: eclipse-mosquitto:1.6.7
        ports:
        - 1883:1883

      mosquitto-extra:
        # Needed by MQTT notification tests (multi broker)
        image: eclipse-mosquitto:1.6.7
        ports:
        - 1884:1883

    name: functional - ${{ matrix.payload.order }}

    strategy:
      matrix:
        payload:
          - { order: '1wc', range: '-e FT_FROM_IX=0 -e FT_TO_IX=300' }
          - { order: '2wc', range: '-e FT_FROM_IX=301 -e FT_TO_IX=600' }
          - { order: '3wc', range: '-e FT_FROM_IX=601 -e FT_TO_IX=900' }
          - { order: '4wc', range: '-e FT_FROM_IX=901 -e FT_TO_IX=1200' }
          - { order: '5wc', range: '-e FT_FROM_IX=1201' }
          - { order: '1nc', range: '-e CB_NO_CACHE=ON -e FT_FROM_IX=0 -e FT_TO_IX=300' }
          - { order: '2nc', range: '-e CB_NO_CACHE=ON -e FT_FROM_IX=301 -e FT_TO_IX=600' }
          - { order: '3nc', range: '-e CB_NO_CACHE=ON -e FT_FROM_IX=601 -e FT_TO_IX=900' }
          - { order: '4nc', range: '-e CB_NO_CACHE=ON -e FT_FROM_IX=901 -e FT_TO_IX=1200' }
          - { order: '5nc', range: '-e CB_NO_CACHE=ON -e FT_FROM_IX=1201' }

    steps:
      - uses: actions/checkout@v2

      - name: Run functional test
        run: |
          docker run  --network host -t --rm ${{ matrix.payload.range }} -v $(pwd):/opt/fiware-orion ${{ env.TEST_IMAGE_NAME }} build -miqts functional
